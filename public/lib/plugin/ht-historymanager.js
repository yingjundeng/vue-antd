!function(x,X,w){"use strict";var b="ht",M=x[b],O=M.Default,Z=O.def,q=O.getInternal();M.HistoryManager=function(S){this._histories=[],this.setDataModel(S)},Z(M.HistoryManager,X,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var i=this;i._betweenTransaction++,1===i._betweenTransaction&&(i._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var v=this,M=v._histories;if(v._betweenTransaction>0&&v._betweenTransaction--,0===v._betweenTransaction){if(v._transactionHistories){var t=[];for(var e in v._transactionHistories)t.push(v._transactionHistories[e]);t.length&&(M=M.slice(0,v._historyIndex+1),M.push(t),M.length>v._maxHistoryCount&&(M=M.slice(M.length-v._maxHistoryCount)),v.setHistories(M),v.setHistoryIndex(M.length-1,!0))}delete v._transactionHistories}}},setDataModel:function(u){var G=this,r=G._dataModel;r!==u&&(r&&(delete r._historyManager,r.ump(G.handleDataModelPropertyChange,G),r.umm(G.$5p,G),r.umd(G.$6p,G),r.removeHierarchyChangeListener(G.handleHierarchyChange,G),r.removeIndexChangeListener(G.handleIndexChange,G)),G._dataModel=u,u&&(u._historyManager=G,u.mp(G.handleDataModelPropertyChange,G),u.mm(G.$5p,G),u.md(G.$6p,G),u.addHierarchyChangeListener(G.handleHierarchyChange,G),u.addIndexChangeListener(G.handleIndexChange,G)),G.fp("dataModel",r,u),G.clear())},setHistoryIndex:function(G,p){var e=this,k=e._historyIndex,a=e._histories.length;if(-1>G?G=-1:G>=a&&(G=a-1),k!==G){if(!p){var y=G-k;y>0?e.$2p(y):0>y&&e.$1p(-y)}e._historyIndex=G,e.fp("historyIndex",k,G),e.dataModel&&e.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(G){var i=this,N=i._histories,l=i._maxHistoryCount;(!G||0>=G)&&(G=10),l!==G&&(i._maxHistoryCount=G,i.fp("maxHistoryCount",l,G),N.length>G&&i.clear())},cloneValue:function(E){return M.Default.clone(E)},isPropertyUndoable:function(T){return T&&!this.ignoredPropertyMap[T]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(k){return k&&!this.ignoreDataModelPropertyMap[k]},$5p:function(n){this.handleChange(n,n.kind)},$6p:function(K){this.handleChange(K,"property")},handleHierarchyChange:function(Q){this.handleChange(Q,"hierarchy")},handleIndexChange:function(w){this.handleChange(w,"index")},handleDataModelPropertyChange:function(X){this.handleChange(X,"dataModelProperty")},toChildrenInfo:function(f){var U={};return U.data=f,U.children=[],f.eachChild(function(J){U.children.push(this.toChildrenInfo(J))},this),U},restoreChildren:function(y){var $=y.data;y.children.forEach(function(t){var U=t.data;U.getParent()!==$&&$.addChild(U),this._dataModel.contains(U)||this._dataModel.add(U),this.restoreChildren(t)},this)},handleChange:function(I,L){var k=this;if(!(k._disabled||k._isUndoRedoing||O.loadingRefGraph)){var D,V=(k._histories,I.data),o=I.property;if(!V||!(V._refGraph||V instanceof M.RefGraph)){if("property"===L)k.isPropertyUndoable(o,V)&&(D={kind:L,data:V,property:o,oldValue:k.cloneValue(I.oldValue,V,o),newValue:k.cloneValue(I.newValue,V,o),event:I});else if("hierarchy"===L||"index"===L&&k.isIndexUndoable(I))D={kind:L,data:V,oldIndex:I.oldIndex,newIndex:I.newIndex,event:I};else if("clear"===L)D={kind:L,json:I.json,event:I};else if("add"===L){if(D={kind:L,data:V,event:I,childrenInfo:this.toChildrenInfo(V),parent:V.getParent()},D.parent){var m=k._dataModel.getSiblings(V);D.siblingsIndex=m.indexOf(V)}V instanceof M.Node&&(D.host=V.getHost(),D.attaches=V.getAttaches()?V.getAttaches().toArray():w),V instanceof M.Edge&&(D.source=V.getSource(),D.target=V.getTarget())}else"remove"===L?D={kind:L,data:V,event:I}:"dataModelProperty"===L&&k.isDataModelPropertyUndoable(o,V)&&(D={kind:L,property:o,oldValue:k.cloneValue(I.oldValue,V,o),newValue:k.cloneValue(I.newValue,V,o),event:I});k.addHistory(D)}}},addHistory:function(Z){var m=this;if(Z)if(m._betweenTransaction){var V=(Z.data?Z.data._id:0)+"_"+Z.kind+"_"+Z.property;if("property"===Z.kind||"dataModelProperty"===Z.kind){var n=m._transactionHistories[V];n&&(Z.oldValue=n.oldValue)}m._transactionHistories[V]=Z}else{var z=m._histories;z=z.slice(0,m._historyIndex+1),z.push([Z]),z.length>m._maxHistoryCount&&(z=z.slice(z.length-m._maxHistoryCount)),m.setHistories(z),m.setHistoryIndex(z.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(K){(!K||0>=K)&&(K=1),this.setHistoryIndex(this._historyIndex-K)},$1p:function(J){if(this.canUndo()){var I,P=this,e=P._dataModel,v=P._histories,l=P._historyIndex,k=0;for(P._isUndoRedoing=!0,O.setIsolating(!0);J>0;){if(l>=0&&l<v.length){k++,I=v[l],l--;for(var w=I.length-1;w>=0;w--){var C=I[w],M=C.kind,S=C.data,Y=C.property,H=C.event,R=this.cloneValue(C.oldValue,S,Y);if(C.undo)C.undo();else if("add"===M)e.remove(S,{keepChildren:!0});else if("remove"===M)e.contains(S)||e.add(S,H.rootsIndex,H.datasIndex);else if("clear"===M)e.deserialize(O.clone(C.json));else if("property"===M)if("parent"===Y)R?R.addChild(S,H.oldIndex):(S.setParent(R),H.oldIndex>=0&&e.moveTo(S,H.oldIndex));else{var n=null;0===Y.indexOf("a:")?(n="attr",Y=Y.replace("a:","")):0===Y.indexOf("s:")?(n="style",Y=Y.replace("s:","")):0===Y.indexOf("f:")&&(n="field",Y=Y.replace("f:","")),q.setPropertyValue(S,n,Y,R)}else if("dataModelProperty"===M){var n=null;0===Y.indexOf("a:")?(n="attr",Y=Y.replace("a:","")):0===Y.indexOf("s:")?(n="style",Y=Y.replace("s:","")):0===Y.indexOf("f:")&&(n="field",Y=Y.replace("f:","")),q.setPropertyValue(e,n,Y,R)}else"hierarchy"===M?e.moveTo(S,C.oldIndex):"index"===M&&e.moveToIndex(S,C.oldIndex)}}J--}O.setIsolating(!1),delete P._isUndoRedoing,P.afterUndo(k)}},afterUndo:function(){},redo:function(m){(!m||0>=m)&&(m=1),this.setHistoryIndex(this._historyIndex+m)},$2p:function(a){if(this.canRedo()){var f,c=this,d=c._dataModel,U=c._histories,u=c._historyIndex,m=0;for(c._isUndoRedoing=!0,O.setIsolating(!0);a>0;){if(u>=-1&&u<U.length-1){m++,u++,f=U[u];for(var I=0;I<f.length;I++){var r=f[I],W=r.kind,_=r.data,v=r.property,p=r.event,Y=this.cloneValue(r.newValue,_,v);if(r.redo)r.redo();else if("add"===W)r.parent&&!_.getParent()&&r.parent.addChild(_,r.siblingsIndex),d.contains(_)||d.add(_,p.rootsIndex,p.datasIndex),this.restoreChildren(r.childrenInfo),_ instanceof M.Node&&(_.setHost(r.host),r.attaches&&r.attaches.forEach(function(J){J.setHost(_)})),_ instanceof M.Edge&&(_.setSource(r.source),_.setTarget(r.target));else if("remove"===W)d.remove(_);else if("clear"===W)d.clear();else if("property"===W)if("parent"===v)Y?Y.addChild(_,p.newIndex):(_.setParent(Y),p.newIndex>=0&&d.moveTo(_,p.newIndex));else{var N=null;0===v.indexOf("a:")?(N="attr",v=v.replace("a:","")):0===v.indexOf("s:")?(N="style",v=v.replace("s:","")):0===v.indexOf("f:")&&(N="field",v=v.replace("f:","")),q.setPropertyValue(_,N,v,Y)}else if("dataModelProperty"===W){var N=null;0===v.indexOf("a:")?(N="attr",v=v.replace("a:","")):0===v.indexOf("s:")?(N="style",v=v.replace("s:","")):0===v.indexOf("f:")&&(N="field",v=v.replace("f:","")),q.setPropertyValue(d,N,v,Y)}else"hierarchy"===W?d.moveTo(_,r.newIndex):"index"===W&&d.moveToIndex(_,r.newIndex)}}a--}O.setIsolating(!1),delete c._isUndoRedoing,this.afterRedo(m)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);